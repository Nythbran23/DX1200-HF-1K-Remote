<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gemini 2-700 CCS</title>
  <style>
    :root { --fg:#111; --bg:#f7f7f7; --ok:#0a7; --bad:#d33; --muted:#666; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:14px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, sans-serif}
    .wrap{max-width:980px;margin:18px auto;padding:0 12px}
    h1{font-size:18px;margin:0 0 12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:#fff;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:12px;flex:1 1 300px}
    .kv{display:grid;grid-template-columns:1fr auto;gap:6px 10px;align-items:baseline}
    .kv label{color:var(--muted)}
    .kv .v{font-variant-numeric:tabular-nums}
    .ctrl{display:grid;grid-template-columns:150px 1fr auto;gap:8px 10px;align-items:center;margin:8px 0}
    input[type="range"]{width:100%}
    input[type="number"], select{width:100%;box-sizing:border-box}
    .status{display:flex;align-items:center;gap:8px;margin:10px 0;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--bad)}
    .dot.ok{background:var(--ok)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}
    .tiny{font-size:12px;color:var(--muted)}
    button{cursor:pointer;border:0;background:#eee;border-radius:8px;padding:6px 10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Gemini 2-700 CCS</h1>

    <div class="status">
      <div id="wsDot" class="dot" aria-hidden="true"></div>
      <div>WS: <span id="wsState">disconnected</span> <span class="tiny">(<span id="wsUrl"></span>)</span></div>
      <div style="margin-left:auto" class="tiny">Tip: add <b>?mock=1</b> to URL for offline demo.</div>
    </div>

    <div class="row">
      <section class="card" aria-labelledby="metricsTitle">
        <h2 id="metricsTitle" class="tiny" style="text-transform:uppercase;letter-spacing:.08em">Live Metrics</h2>
        <div id="metrics" class="kv"></div>
      </section>

      <section class="card" aria-labelledby="controlsTitle">
        <h2 id="controlsTitle" class="tiny" style="text-transform:uppercase;letter-spacing:.08em">Public Controls</h2>
        <div id="controls"></div>
        <div class="tiny">Controls disabled unless PA State = RX.</div>
      </section>
    </div>

    <details class="card" style="margin-top:12px">
      <summary>Private Setup</summary>
      <div class="row">
        <section class="card" style="flex:1 1 320px">
          <h2 class="tiny" style="text-transform:uppercase;letter-spacing:.08em">Private Metrics</h2>
          <div id="priv-metrics" class="kv"></div>
        </section>
        <section class="card" style="flex:2 1 420px">
          <h2 class="tiny" style="text-transform:uppercase;letter-spacing:.08em">Calibration & Fan Settings</h2>
          <div id="priv-controls"></div>
        </section>
      </div>
    </details>

    <details class="card" style="margin-top:12px">
      <summary>Debug</summary>
      <div class="mono" id="debug"></div>
    </details>
  </div>

<script>
// ------- schema-driven UI (compact) -------
const METRICS = [
  {id:'status',        label:'Status',                unit:''},
  {id:'preamp',        label:'Preamp',                unit:''},
  {id:'pa_state',      label:'PA State',              unit:''},
  {id:'pa_temp',       label:'PA Temp',               unit:'°C', digits:1},
  {id:'psu_temp',      label:'PSU Temp',              unit:'°C', digits:1},
  {id:'fan1_pwm',      label:'Fan 1 PWM',             unit:'%', digits:0},
  {id:'fan1_speed',    label:'Fan 1 Speed',           unit:'RPM'},
  {id:'fan2_pwm',      label:'Fan 2 PWM',             unit:'%', digits:0},
  {id:'fan2_speed',    label:'Fan 2 Speed',           unit:'RPM'},
  {id:'fwd_power',     label:'RF Forward Power',      unit:'W', digits:1},
  {id:'rev_power',     label:'RF Reflected Power',    unit:'W', digits:1},
  {id:'vswr',          label:'VSWR',                  unit:'',  digits:2},
  {id:'pa_voltage',    label:'PA Voltage',            unit:'V', digits:2},
  {id:'pa_current',    label:'PA Current',            unit:'A', digits:2},
  {id:'ot_trip',       label:'Overtemp Trip',         unit:''},
  {id:'od_trip',       label:'Overdrive Trip',        unit:''},
  {id:'hvswr_trip',    label:'High VSWR Trip',        unit:''},
  {id:'fanlock_alarm', label:'Fan Lock Alarm',        unit:''},
  {id:'mac',           label:'MAC Address',           unit:''}
];

const CONTROLS = [
  {id:'preamp_output',  label:'Preamp Output', type:'select', options:['Rear Panel','Bias T']},
  {id:'preamp_voltage', label:'Preamp Voltage', type:'range', min:12.0, max:15.0, step:0.1, unit:'V'},
  {id:'preamp_delay',   label:'Preamp Seq Delay', type:'range', min:30, max:100, step:10, unit:'ms'}
];

const PRIVATE_METRICS = [
  {id:'adc_fwd',    label:'ADC FWD',   unit:''},
  {id:'adc_rev',    label:'ADC REV',   unit:''},
  {id:'adc_odrive', label:'ADC ODRIVE',unit:''}
];

const PRIVATE_CONTROLS = [
  {id:'cal_fwd_50',   label:'FWD ADC @ 50W',  type:'number'},
  {id:'cal_fwd_100',  label:'FWD ADC @ 100W', type:'number'},
  {id:'cal_fwd_300',  label:'FWD ADC @ 300W', type:'number'},
  {id:'cal_fwd_500',  label:'FWD ADC @ 500W', type:'number'},
  {id:'cal_odrive',   label:'ODRIVE Trip ADC',type:'number'},
  {id:'cal_swr_1_0',  label:'SWR 1.0:1 Adj',  type:'number'},

  {id:'fan1_min',     label:'Fan 1 Min Speed',   type:'number'},
  {id:'fan1_ramp',    label:'Fan 1 Start Temp',  type:'number'},
  {id:'fan1_max',     label:'Fan 1 Max Temp',    type:'number'},
  {id:'fan1_hyst',    label:'Fan 1 Hyst',        type:'number'},

  {id:'fan2_min',     label:'Fan 2 Min Speed',   type:'number'},
  {id:'fan2_ramp',    label:'Fan 2 Start Temp',  type:'number'},
  {id:'fan2_max',     label:'Fan 2 Max Temp',    type:'number'},
  {id:'fan2_hyst',    label:'Fan 2 Hyst',        type:'number'}
];

// ------- DOM build -------
const mWrap = document.getElementById('metrics');
const cWrap = document.getElementById('controls');
const privMetricsWrap = document.getElementById('priv-metrics');
const privControlsWrap = document.getElementById('priv-controls');
const debug = document.getElementById('debug');

const metricEls = {}; // id -> span
METRICS.forEach(m => {
  const lab = document.createElement('label'); lab.textContent = m.label;
  const val = document.createElement('div'); val.className = 'v'; val.id = 'm_'+m.id; val.textContent = '--';
  metricEls[m.id] = val;
  mWrap.appendChild(lab); mWrap.appendChild(val);
});

// Private metrics
const privMetricEls = {};
PRIVATE_METRICS.forEach(m => {
  const lab = document.createElement('label'); lab.textContent = m.label;
  const val = document.createElement('div'); val.className = 'v'; val.id = 'pm_'+m.id; val.textContent = '--';
  privMetricEls[m.id] = val;
  privMetricsWrap.appendChild(lab); privMetricsWrap.appendChild(val);
});

function makeCtrl(ctrl){
  const row = document.createElement('div'); row.className = 'ctrl';
  const lab = document.createElement('label'); lab.textContent = ctrl.label; row.appendChild(lab);
  let input; let readout = document.createElement('div'); readout.className = 'mono tiny';
  if(ctrl.type === 'range'){
    input = document.createElement('input'); input.type='range'; input.name = ctrl.id;
    Object.assign(input, {min:ctrl.min, max:ctrl.max, step:ctrl.step, value:ctrl.min});
    row.appendChild(input);
    row.appendChild(readout);
  } else if(ctrl.type === 'number'){
    input = document.createElement('input'); input.type='number'; input.name = ctrl.id;
    Object.assign(input, {min:ctrl.min ?? '', max:ctrl.max ?? '', step:ctrl.step ?? 'any'});
    row.appendChild(input);
    const btn = document.createElement('button'); btn.textContent='Send'; btn.onclick=()=>sendSetting(ctrl.id, asNumber(input.value));
    row.appendChild(btn);
  } else if(ctrl.type === 'toggle'){
    input = document.createElement('input'); input.type='checkbox'; input.name = ctrl.id;
    row.appendChild(input);
    const btn = document.createElement('button'); btn.textContent='Apply'; btn.onclick=()=>sendSetting(ctrl.id, input.checked ? 1 : 0);
    row.appendChild(btn);
  } else if(ctrl.type === 'select'){
    input = document.createElement('select'); input.name = ctrl.id;
    (ctrl.options||[]).forEach(opt=>{ const o=document.createElement('option'); o.value=opt; o.textContent=opt; input.appendChild(o); });
    row.appendChild(input);
    const btn = document.createElement('button'); btn.textContent='Apply'; btn.onclick=()=>sendSetting(ctrl.id, input.value);
    row.appendChild(btn);
  }
  input && input.addEventListener && input.addEventListener('input', ()=>{
    if(ctrl.type==='range'){
      readout.textContent = input.value + (ctrl.unit?(' '+ctrl.unit):'');
      debouncedSend(ctrl.id, asNumber(input.value));
    }
  });
  input && input.addEventListener && input.addEventListener('change', ()=>{
    if(ctrl.type==='number') sendSetting(ctrl.id, asNumber(input.value));
  });
  return row;
}

CONTROLS.forEach(c => cWrap.appendChild(makeCtrl(c)));
PRIVATE_CONTROLS.forEach(c => privControlsWrap.appendChild(makeCtrl(c)));

function fmt(val, digits){
  if(val===null || val===undefined || Number.isNaN(val)) return '--';
  if(typeof val === 'number' && isFinite(val)) return val.toFixed(digits ?? 0);
  return String(val);
}

function asNumber(v){ const n = parseFloat(v); return isFinite(n)?n:0; }

// ------- WebSocket with tiny reconnection -------
const wsUrlEl = document.getElementById('wsUrl');
const wsStateEl = document.getElementById('wsState');
const wsDot = document.getElementById('wsDot');
const params = new URLSearchParams(location.search);
const MOCK = params.get('mock')==='1';
const wsPath = params.get('ws') || (location.protocol.replace('http','ws') + '//' + location.host + '/ws');
wsUrlEl.textContent = wsPath;

let ws, backoff = 300;
function connect(){
  if(MOCK){ wsStateEl.textContent='mock mode'; wsDot.classList.add('ok'); startMock(); return; }
  try{
    ws = new WebSocket(wsPath);
    ws.onopen = ()=>{ wsStateEl.textContent='connected'; wsDot.classList.add('ok'); backoff = 300; };
    ws.onclose = ()=>{ wsStateEl.textContent='disconnected'; wsDot.classList.remove('ok'); retry(); };
    ws.onerror = ()=>{ wsStateEl.textContent='error'; wsDot.classList.remove('ok'); ws.close(); };
    ws.onmessage = (ev)=>{
      try{
        const msg = JSON.parse(ev.data);
        applyUpdate(msg);
        log('rx', msg);
      }catch(e){ log('rx-invalid', ev.data); }
    };
  }catch(e){ retry(); }
}
function retry(){ setTimeout(connect, backoff); backoff = Math.min(backoff*1.7, 5000); }
connect();

// Keepalive ping every 20s
setInterval(()=>{ if(ws && ws.readyState===1) ws.send('{"ping":1}'); }, 20000);

function setPublicControlsDisabled(disabled){
  cWrap.querySelectorAll('input,select,button').forEach(el=>{ el.disabled = disabled; });
}

// ------- Applying incoming telemetry -------
function applyUpdate(obj){
  METRICS.forEach(m=>{ if(obj[m.id] !== undefined){ metricEls[m.id].textContent = fmt(obj[m.id], m.digits) + (m.unit?(' '+m.unit):''); } });
  PRIVATE_METRICS.forEach(m=>{ if(obj[m.id] !== undefined){ const el=privMetricEls[m.id]; if(el) el.textContent = fmt(obj[m.id], m.digits) + (m.unit?(' '+m.unit):''); } });

  // Sync controls if firmware echoes state (same names without set_ or identical ids)
  [...CONTROLS, ...PRIVATE_CONTROLS].forEach(c=>{
    const key = (c.id.startsWith('set_')? c.id.replace(/^set_/, '') : c.id);
    if(obj[key] !== undefined){
      const el = document.querySelector(`[name="${c.id}"]`);
      if(el){ if(c.type==='toggle') el.checked = !!obj[key]; else el.value = obj[key]; }
    }
  });
  // Soft gating: public controls only valid if PA is RX
  if('pa_state' in obj){ setPublicControlsDisabled(String(obj.pa_state).toUpperCase()!=='RX'); }
}

// ------- Minimal debug log -------
function log(dir, obj){
  const line = `[${new Date().toLocaleTimeString()}] ${dir}: ${typeof obj==='string'?obj:JSON.stringify(obj)}`;
  const el = document.createElement('div'); el.textContent = line; debug.prepend(el);
  const max = 120; while(debug.childNodes.length>max) debug.removeChild(debug.lastChild);
}

// ------- Mock for standalone testing -------
let mockT=0; let mockTimer;
function startMock(){
  if(mockTimer) clearInterval(mockTimer);
  mockTimer = setInterval(()=>{
    mockT+=1; const obj={
      status: (mockT%20<10?'Standby':'Operate'),
      preamp: (mockT%8<4?'On':'Off'),
      pa_state: (mockT%6<3?'RX':'TX'),
      pa_temp: 30 + 10*Math.sin(mockT/20),
      psu_temp: 28 + 7*Math.sin(mockT/27),
      fan1_pwm: Math.round(20+20*Math.abs(Math.sin(mockT/15))),
      fan1_speed: Math.round(1200+300*Math.abs(Math.sin(mockT/12))),
      fan2_pwm: Math.round(25+25*Math.abs(Math.cos(mockT/17))),
      fan2_speed: Math.round(1300+250*Math.abs(Math.cos(mockT/14))),
      fwd_power: Math.max(0, 100 + 60*Math.sin(mockT/10)),
      rev_power: Math.max(0, 5 + 3*Math.sin(mockT/9)),
      vswr: 1.05 + 0.3*Math.abs(Math.sin(mockT/40)),
      pa_voltage: 50.3,
      pa_current: 6.2 + 0.5*Math.abs(Math.sin(mockT/18)),
      ot_trip: 0,
      od_trip: 0,
      hvswr_trip: 0,
      fanlock_alarm: 0,
      mac: '02:12:34:56:78:9A',
      adc_fwd: 1263 + Math.round(50*Math.sin(mockT/8)),
      adc_rev: 200 + Math.round(20*Math.sin(mockT/11)),
      adc_odrive: 1800 + Math.round(30*Math.sin(mockT/7))
    };
    applyUpdate(obj); log('rx(mock)', obj);
  }, 1000);
}
</script>
</body>
</html>
